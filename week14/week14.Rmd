
# leaflet

## Manuals 

  * R: <https://rstudio.github.io/leaflet/>
  * JS: <https://leafletjs.com/examples/quick-start/>

## leaflet for R

### Create canvas

```{r}
library(leaflet)
m = leaflet() %>% setView(lng=121.5, lat=25.05, zoom=13) 
m
```

```{r}
m$x$setView |> jsonlite::toJSON(auto_unbox = T) |>
  clipr::write_clip()
```


### Add tiles

```{r}
m |> leaflet::addTiles() -> m
m
```

```{r}
m$x$calls[[1]]$method # "addTiles"
m$x$calls[[1]]$args |>
  jsonlite::toJSON(auto_unbox = T) |>
  clipr::write_clip()
```

#### econIDV

```{r}
lf = econIDV::LeafletTools()

m$x$calls[[1]] |>
  lf$getTileArgsFromCall()

lf$tile$js()
```

### Add Markers

```{r}  
m |> addMarkers(lng=121.5, lat=25.05, popup = "taipei") -> m
m
```

```{r}
m$x$calls[[2]]$args |> jsonlite::toJSON(auto_unbox = T)
```

  * popup: click then show information
  
  * tooltip: mouse hover then show information


```{r}
m$x$calls[[2]] |> lf$getMarkerArgsFromCall()
lf$marker$js()
```


```{js}

var latLng = L.latLng(${markerArgs$lat},${markerArgs$lng});
var mk = L.marker(latLng,
             ${markerArgs$markerOptions})
// markers bind popup
mk.bindPopup(${markerArgs$popup$content},
                   ${markerArgs$popup$options})

```


# User GPS


```js
function successCallback(position){
  console.log(position);
  currentLocation = [position.coords.latitude, position.coords.longitude];
};

function errorCallback(error){
  console.log(error);
};

navigator.geolocation.getCurrentPosition(successCallback, errorCallback);
```

  * Reference: <https://developer.mozilla.org/en-US/docs/Web/API/Geolocation_API/Using_the_Geolocation_API>
  * in `init.js`


# Youbike 2.0

  * [新北市API](https://data.ntpc.gov.tw/openapi/swagger-ui/index.html?configUrl=%2Fapi%2Fv1%2Fopenapi%2Fswagger%2Fconfig&urls.primaryName=%E6%96%B0%E5%8C%97%E5%B8%82%E6%94%BF%E5%BA%9C%E4%BA%A4%E9%80%9A%E5%B1%80(80))
    * Youbike2.0 500 obs: <https://data.ntpc.gov.tw/api/datasets/010e5b15-3823-4b20-b401-b1cf000550c5/json?size=500>

  * [台北市API](https://tcgbusfs.blob.core.windows.net/dotapp/youbike/v2/youbike_immediate.json)

## data merge

To pass merged data to the flexdashboard, add the following code:
```r
ubikeMap = readRDS("ubikeMap.Rds")
htmltools::tags$script(
  id="youbike-data",
  type="application/json",
  ubikeMap$dataMerged[,c("lat","lng")] |> jsonlite::toJSON(auto_unbox = T)
)
```

# Github Desktop

  * copy the url of the repo
  * launch Github Desktop
  * Under `File` menu, choose `Clone repository`
  * Choose tab `URL`, paste the url, and choose the local path
  * click `Clone`
  

# JS knowledge

```js
if(leaflet.map){
  ...
}
```

  * `leaflet.map` is `true` if `leaflet.map` is not `undefined` or `null` or `false` or `0` or `NaN` or `""` (empty string)

```js
if(!leaflet.map){
  ...
}
```

  * `!leaflet.map` is `true` if `leaflet.map` is `undefined` or `null` or `false` or `0` or `NaN` or `""` (empty string)

